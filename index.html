<!DOCTYPE html>
<html lang="ja" class="antialiased">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>词点</title>
    <!-- 引入 Tailwind CSS (Play CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <!-- 引入 Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 自定义滚动条样式 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.2);
        }
        
        .library-item {
            transition: all 0.2s ease;
        }
        
        .library-item:hover {
            background-color: rgba(16, 185, 129, 0.1);
        }
        
        .editing-library {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        /* 修复的角标样式 */
        .highlight-group {
            position: relative;
            overflow: hidden;
        }
        
        .highlight-group::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 40px 40px 0;  /* 增大尺寸 */
            border-color: transparent #10b981 transparent transparent;
            z-index: 1;
        }
        
        .highlight-group::before {
            content: '推荐';
            position: absolute;
            top: 4px;  /* 调整位置 */
            right: -4px; /* 调整位置 */
            z-index: 2;
            color: white;
            font-size: 10px;
            font-weight: bold;
            transform: rotate(45deg);
            width: 40px;
            text-align: center;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
</head>

<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 transition-colors duration-200">
    <div id="app" class="min-h-screen flex flex-col">
        <!-- 顶部导航栏，包含标题和主题切换按钮 -->
        <header
            class="p-4 bg-gradient-to-r from-green-500 to-teal-500 dark:from-green-700 dark:to-teal-700 text-white flex justify-between items-center shadow-md">
            <div class="flex items-center space-x-3">
                <i class="fas fa-language text-2xl"></i>
                <h1 class="text-xl font-bold">词点</h1>
            </div>
            <div class="flex items-center space-x-4">
                <div class="bg-white/20 rounded-full px-3 py-1">
                    <span class="font-mono">{{ stats.correct }}/{{ stats.total }} ({{ accuracy }}%)</span>
                </div>
                <button @click="toggleTheme"
                    class="bg-white/20 hover:bg-white/30 transition-colors rounded-full p-2 flex items-center justify-center">
                    <i :class="theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon'"></i>
                </button>
            </div>
        </header>

        <!-- 主内容区 -->
        <main class="flex-grow p-4 container mx-auto">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- 左侧面板分离 -->
                <template v-if="currentView==='japanese'">
                    <div class="lg:col-span-1 space-y-6">
                        <!-- 日语模式左侧内容（原有内容） -->
                        <section class="bg-white dark:bg-gray-800 rounded-xl shadow p-4">
                            <div class="flex justify-between items-center mb-3">
                                <h2 class="text-lg font-semibold flex items-center">
                                    <i class="fas fa-th-list mr-2 text-green-500"></i> 选择假名组
                                </h2>
                                <button @click="showLibraryManager = true" class="text-sm text-green-600 hover:text-green-800 dark:hover:text-green-400">
                                    <i class="fas fa-cog mr-1"></i>管理词库
                                </button>
                            </div>
                            <div class="custom-scrollbar grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2 max-h-[400px] overflow-y-auto pr-2">
                                <!-- 推荐练习组 -->
                                <div class="col-span-full text-xs text-gray-500 font-medium mt-2 mb-1">推荐练习</div>
                                <button v-for="row in recommendedGroups" :key="row.name" @click="selectRow(row)"
                                    class="highlight-group p-2 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-green-100 dark:hover:bg-green-900 transition-colors flex flex-col items-center">
                                    <span class="font-bold">{{ row.name }}</span>
                                    <span class="text-xs mt-1">{{ row.kana.length }}个假名</span>
                                </button>
                                <!-- 自定义模式入口（加推荐角标，修正大小） -->
                                <button @click="switchToCustom" :class="{'ring-2 ring-pink-500': currentView==='custom'}"
                                    class="highlight-group p-2 bg-pink-50 dark:bg-pink-900/30 rounded-lg hover:bg-pink-100 dark:hover:bg-pink-900/50 transition-colors flex flex-col items-center w-full min-h-[72px] justify-center">
                                    <span class="font-bold text-pink-700 dark:text-pink-200 text-base">自定义词库练习</span>
                                    <span class="text-xs mt-1">支持双词/三词</span>
                                </button>
                                <!-- 标准五十音行 -->
                                <div class="col-span-full text-xs text-gray-500 font-medium mt-4 mb-1">标准五十音行</div>
                                <button v-for="row in kanaRows" :key="row.name" @click="selectRow(row)"
                                    :class="{'ring-2 ring-green-500': selectedRow && selectedRow.id === row.id}"
                                    class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-green-100 dark:hover:bg-green-900 transition-colors flex flex-col items-center">
                                    <span class="font-bold">{{ row.name }}</span>
                                    <span class="text-xs mt-1">{{ row.kana[0] }}{{ row.katakana[0] }}</span>
                                </button>
                                <!-- 导入的词库 -->
                                <div class="col-span-full text-xs text-gray-500 font-medium mt-4 mb-1" v-if="importedLibraries.length > 0">
                                    导入的词库
                                </div>
                                <button v-for="lib in importedLibraries" :key="lib.id" @click="selectLibrary(lib)"
                                    :class="{'ring-2 ring-yellow-500': selectedRow && selectedRow.id === lib.id}"
                                    class="library-item p-2 bg-yellow-50 dark:bg-yellow-900/30 rounded-lg hover:bg-yellow-100 dark:hover:bg-yellow-900/50 transition-colors flex flex-col items-center relative">
                                    <span class="font-bold text-sm">{{ lib.name }}</span>
                                    <span class="text-xs mt-1">{{ lib.words.length }}个词汇</span>
                                    <button @click.stop="editLibraryName(lib)" class="absolute top-1 right-1 text-xs text-gray-500 hover:text-yellow-600">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </button>
                            </div>
                        </section>

                        <!-- 练习设置 -->
                        <section class="bg-white dark:bg-gray-800 rounded-xl shadow p-4">
                            <h2 class="text-lg font-semibold mb-3 flex items-center">
                                <i class="fas fa-cogs mr-2 text-blue-500"></i> 练习模式
                            </h2>
                            <div class="grid grid-cols-1 gap-2">
                                <button @click="setMode('kana-romaji')"
                                    :class="mode === 'kana-romaji' ? 'bg-green-500 text-white' : 'bg-gray-100 dark:bg-gray-700'"
                                    class="px-4 py-3 rounded-lg flex items-center justify-between transition-all">
                                    <span>假名 → 罗马音</span>
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                                <button @click="setMode('romaji-kana')"
                                    :class="mode === 'romaji-kana' ? 'bg-green-500 text-white' : 'bg-gray-100 dark:bg-gray-700'"
                                    class="px-4 py-3 rounded-lg flex items-center justify-between transition-all">
                                    <span>罗马音 → 假名</span>
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                                <button @click="setMode('hiragana-katakana')"
                                    :class="mode === 'hiragana-katakana' ? 'bg-green-500 text-white' : 'bg-gray-100 dark:bg-gray-700'"
                                    class="px-4 py-3 rounded-lg flex items-center justify-between transition-all">
                                    <span>平假名 ↔ 片假名</span>
                                    <i class="fas fa-exchange-alt"></i>
                                </button>
                            </div>
                        </section>
                    </div>
                </template>
                <template v-else>
                    <div class="lg:col-span-1 space-y-6">
                        <!-- 自定义模式左侧内容 -->
                        <button @click="switchToJapanese" class="w-full py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                            <i class="fas fa-arrow-left mr-2"></i>返回日语模式
                        </button>
                        <!-- 三词词库对照模式选择 -->
                        <section v-if="selectedCustomLibrary && selectedCustomLibrary.type==='triple'" class="bg-white dark:bg-gray-800 rounded-xl shadow p-4 mt-4">
                            <h2 class="text-lg font-semibold mb-3 flex items-center">
                                <i class="fas fa-random mr-2 text-pink-500"></i> 对照模式
                            </h2>
                            <div class="flex flex-col gap-2">
                                <label>
                                    <input type="radio" value="a-b" v-model="tripleMode" class="mr-2"> {{ selectedCustomLibrary.words[0]?.word1 || 'A' }} → {{ selectedCustomLibrary.words[0]?.word2 || 'B' }}
                                </label>
                                <label>
                                    <input type="radio" value="b-c" v-model="tripleMode" class="mr-2"> {{ selectedCustomLibrary.words[0]?.word2 || 'B' }} → {{ selectedCustomLibrary.words[0]?.word3 || 'C' }}
                                </label>
                                <label>
                                    <input type="radio" value="a-c" v-model="tripleMode" class="mr-2"> {{ selectedCustomLibrary.words[0]?.word1 || 'A' }} → {{ selectedCustomLibrary.words[0]?.word3 || 'C' }}
                                </label>
                            </div>
                        </section>
                        <!-- 自定义词库管理入口 -->
                        <section class="bg-white dark:bg-gray-800 rounded-xl shadow p-4 mt-4">
                            <div class="flex justify-between items-center mb-3">
                                <h2 class="text-lg font-semibold flex items-center">
                                    <i class="fas fa-cogs mr-2 text-pink-500"></i> 词库管理
                                </h2>
                                <button @click="showCustomLibraryManager = true" class="text-sm text-pink-600 hover:text-pink-800 dark:hover:text-pink-400">
                                    <i class="fas fa-cog mr-1"></i>管理
                                </button>
                            </div>
                        </section>
                    </div>
                </template>
                <!-- 主内容区分离 -->
                <div class="lg:col-span-2 space-y-6">
                    <template v-if="currentView==='japanese'">
                        <!-- 题型选择 -->
                        <section class="bg-white dark:bg-gray-800 rounded-xl shadow p-4">
                            <h2 class="text-lg font-semibold mb-3 flex items-center">
                                <i class="fas fa-pencil-alt mr-2 text-purple-500"></i> 题型选择
                            </h2>
                            <div class="flex gap-4">
                                <button @click="questionType = 'multiple'"
                                    :class="questionType === 'multiple' ? 'bg-purple-500 text-white' : 'bg-gray-100 dark:bg-gray-700'"
                                    class="px-4 py-2 rounded-lg flex-1 flex items-center justify-center">
                                    <i class="fas fa-list-ol mr-2"></i>选择题
                                </button>
                                <button @click="questionType = 'input'"
                                    :class="questionType === 'input' ? 'bg-purple-500 text-white' : 'bg-gray-100 dark:bg-gray-700'"
                                    class="px-4 py-2 rounded-lg flex-1 flex items-center justify-center">
                                    <i class="fas fa-keyboard mr-2"></i>拼写题
                                </button>
                            </div>
                        </section>

                        <!-- JSON 题库上传 -->
                        <section class="bg-white dark:bg-gray-800 rounded-xl shadow p-4">
                            <h2 class="text-lg font-semibold mb-3 flex items-center">
                                <i class="fas fa-file-import mr-2 text-yellow-500"></i> 导入词库 (JSON)
                            </h2>
                            <div class="flex gap-2">
                                <input type="file" accept=".json" @change="loadJson"
                                    class="border p-2 rounded-lg bg-gray-50 dark:bg-gray-700 flex-grow" />
                                <button @click="downloadSample" class="px-3 bg-gray-200 dark:bg-gray-700 rounded-lg">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </section>

                        <!-- 练习区域 -->
                        <section class="bg-white dark:bg-gray-800 rounded-xl shadow p-6">
                            <div v-if="currentQuestion" class="text-center">
                                <div class="mb-6">
                                    <p class="text-lg mb-2">请{{ questionType === 'multiple' ? '选择' : '输入' }}下列的 {{
                                        modeDescription }}：</p>
                                    <div class="text-5xl font-bold min-h-[80px] flex items-center justify-center mb-2">
                                        {{ questionPrompt }}
                                    </div>
                                    <div v-if="mode === 'hiragana-katakana'" class="text-sm text-gray-500">
                                        {{ direction === 'hira-to-kata' ? '(平假名 → 片假名)' : '(片假名 → 平假名)' }}
                                    </div>
                                    <div v-if="hasDuplicateOptions" class="text-xs text-gray-500 mt-1">
                                        <i class="fas fa-info-circle"></i> 选项包含重复假名，重复选项不属于正确选项！（已用*标记）
                                    </div>
                                </div>

                                <!-- 选择题选项 -->
                                <div v-if="questionType === 'multiple'" class="grid grid-cols-2 gap-4 mb-6">
                                    <button v-for="(opt, idx) in currentOptions" :key="idx" @click="answer(opt)"
                                        class="p-4 bg-blue-50 dark:bg-blue-900 rounded-xl hover:bg-blue-100 dark:hover:bg-blue-800 transition-colors text-xl font-medium">
                                        {{ opt }}
                                    </button>
                                </div>

                                <!-- 填写题输入 -->
                                <div v-if="questionType === 'input'" class="mb-6">
                                    <div class="relative">
                                        <input v-model="userInput" @keyup.enter="submitAnswer"
                                            class="border-2 p-4 rounded-xl w-full bg-gray-50 dark:bg-gray-700 text-xl focus:outline-none focus:ring-2 focus:ring-green-500"
                                            placeholder="请输入答案" />
                                        <button @click="submitAnswer"
                                            class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-green-500 text-white rounded-lg px-4 py-2">
                                            提交
                                        </button>
                                    </div>
                                </div>

                                <!-- 反馈 -->
                                <div v-if="feedback" class="mt-4">
                                    <div :class="feedback === '正确' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'"
                                        class="p-4 rounded-xl text-lg">
                                        <i :class="feedback === '正确' ? 'fas fa-check-circle' : 'fas fa-times-circle'"
                                            class="mr-2"></i>
                                        {{ feedback }}
                                        <span v-if="feedback === '错误'">正确答案: {{ correctAnswer }}</span>
                                    </div>
                                    <button @click="nextQuestion"
                                        class="mt-4 px-6 py-2 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-colors">
                                        <i class="fas fa-arrow-right mr-2"></i>下一题
                                    </button>
                                </div>
                            </div>

                            <div v-else class="text-center py-12">
                                <i class="fas fa-book-open text-5xl text-gray-300 mb-4"></i>
                                <p class="text-xl">请选择假名组开始练习</p>
                            </div>
                        </section>
                    </template>
                    <template v-if="currentView==='custom'">
                        <!-- 题库上传与示例下载 -->
                        <section class="bg-white dark:bg-gray-800 rounded-xl shadow p-4 mb-4">
                            <h2 class="text-lg font-semibold mb-3 flex items-center">
                                <i class="fas fa-file-import mr-2 text-pink-500"></i> 导入自定义词库 (JSON)
                            </h2>
                            <div class="flex gap-2 mb-2">
                                <input type="file" accept=".json" @change="loadCustomJson"
                                    class="border p-2 rounded-lg bg-gray-50 dark:bg-gray-700 flex-grow" />
                                <button @click="downloadCustomSample('double')" class="px-3 bg-pink-200 dark:bg-pink-700 rounded-lg text-pink-900 dark:text-pink-100 mr-1">
                                    <i class="fas fa-download"></i> 双词示例
                                </button>
                                <button @click="downloadCustomSample('triple')" class="px-3 bg-pink-200 dark:bg-pink-700 rounded-lg text-pink-900 dark:text-pink-100">
                                    <i class="fas fa-download"></i> 三词示例
                                </button>
                            </div>
                        </section>
                        <!-- 词库管理 -->
                        <section class="bg-white dark:bg-gray-800 rounded-xl shadow p-4 mb-4">
                            <h2 class="text-lg font-semibold mb-3 flex items-center">
                                <i class="fas fa-cogs mr-2 text-pink-500"></i> 自定义词库管理
                            </h2>
                            <div class="flex flex-wrap gap-2 mb-2">
                                <button v-for="lib in customLibraries" :key="lib.id" @click="selectCustomLibrary(lib)"
                                    :class="{'ring-2 ring-pink-500': selectedCustomLibrary && selectedCustomLibrary.id === lib.id}"
                                    class="p-2 bg-pink-50 dark:bg-pink-900/30 rounded-lg hover:bg-pink-100 dark:hover:bg-pink-900/50 transition-colors flex flex-col items-center">
                                    <span class="font-bold">{{ lib.name }}</span>
                                    <span class="text-xs mt-1">{{ lib.words.length }}词</span>
                                    <span class="text-xs mt-1">{{ lib.type === 'double' ? '双词' : '三词' }}</span>
                                </button>
                            </div>
                            <div v-if="customLibraries.length === 0" class="text-center text-gray-400">暂无自定义词库</div>
                        </section>
                        <!-- 练习区域 -->
                        <section class="bg-white dark:bg-gray-800 rounded-xl shadow p-6">
                            <div v-if="currentCustomQuestion && selectedCustomLibrary" class="text-center">
                                <div class="mb-6">
                                    <p class="text-lg mb-2">请{{ customQuestionType === 'multiple' ? '选择' : '输入' }}下列的 {{ customModeDescription }}：</p>
                                    <div class="text-3xl font-bold min-h-[60px] flex items-center justify-center mb-2">
                                        {{ customQuestionPrompt }}
                                    </div>
                                </div>
                                <!-- 选择题选项 -->
                                <div v-if="customQuestionType === 'multiple'" class="grid grid-cols-2 gap-4 mb-6">
                                    <button v-for="(opt, idx) in currentCustomOptions" :key="idx" @click="answerCustom(opt)"
                                        class="p-4 bg-pink-50 dark:bg-pink-900 rounded-xl hover:bg-pink-100 dark:hover:bg-pink-800 transition-colors text-xl font-medium">
                                        {{ opt }}
                                    </button>
                                </div>
                                <!-- 填写题输入 -->
                                <div v-if="customQuestionType === 'input'" class="mb-6">
                                    <div class="relative">
                                        <input v-model="customUserInput" @keyup.enter="submitCustomAnswer"
                                            class="border-2 p-4 rounded-xl w-full bg-gray-50 dark:bg-gray-700 text-xl focus:outline-none focus:ring-2 focus:ring-pink-500"
                                            placeholder="请输入答案" />
                                        <button @click="submitCustomAnswer"
                                            class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-pink-500 text-white rounded-lg px-4 py-2">
                                            提交
                                        </button>
                                    </div>
                                </div>
                                <!-- 反馈 -->
                                <div v-if="customFeedback" class="mt-4">
                                    <div :class="customFeedback === '正确' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'"
                                        class="p-4 rounded-xl text-lg">
                                        <i :class="customFeedback === '正确' ? 'fas fa-check-circle' : 'fas fa-times-circle'"
                                            class="mr-2"></i>
                                        {{ customFeedback }}
                                        <span v-if="customFeedback === '错误'">正确答案: {{ customCorrectAnswer }}</span>
                                    </div>
                                    <button @click="nextCustomQuestion"
                                        class="mt-4 px-6 py-2 bg-pink-500 text-white rounded-xl hover:bg-pink-600 transition-colors">
                                        <i class="fas fa-arrow-right mr-2"></i>下一题
                                    </button>
                                </div>
                            </div>
                            <div v-else class="text-center py-12">
                                <i class="fas fa-book-open text-5xl text-gray-300 mb-4"></i>
                                <p class="text-xl">请选择自定义词库开始练习</p>
                            </div>
                        </section>
                    </template>
                </div>
            </div>
        </main>

        <!-- 词库管理模态框 -->
        <div v-if="showLibraryManager" class="fixed inset-0 bg-transparent bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-md max-h-[80vh] flex flex-col">
                <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <h3 class="text-lg font-semibold">词库管理</h3>
                    <button @click="showLibraryManager = false" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="p-4 flex-1 overflow-y-auto custom-scrollbar">
                    <div v-for="lib in importedLibraries" :key="lib.id" 
                         class="flex items-center justify-between p-3 mb-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <div class="flex-1">
                            <input v-if="editingLibrary && editingLibrary.id === lib.id" 
                                   v-model="editingLibrary.name" 
                                   @keyup.enter="saveLibraryName"
                                   @blur="saveLibraryName"
                                   class="w-full px-2 py-1 bg-white dark:bg-gray-800 rounded border border-green-500"/>
                            <span v-else class="font-medium">{{ lib.name }}</span>
                        </div>
                        <div class="flex space-x-2">
                            <button @click="editLibraryName(lib)" class="text-blue-600 hover:text-blue-800">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button @click="deleteLibrary(lib)" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div v-if="importedLibraries.length === 0" class="text-center py-8 text-gray-500">
                        <i class="fas fa-inbox text-3xl mb-3"></i>
                        <p>暂无导入的词库</p>
                    </div>
                </div>
                
                <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end">
                    <button @click="showLibraryManager = false" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">
                        关闭
                    </button>
                </div>
            </div>
        </div>

        <!-- 自定义词库管理模态框 -->
        <div v-if="showCustomLibraryManager" class="fixed inset-0 bg-transparent bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-md max-h-[80vh] flex flex-col">
                <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <h3 class="text-lg font-semibold">自定义词库管理</h3>
                    <button @click="showCustomLibraryManager = false" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-4 flex-1 overflow-y-auto custom-scrollbar">
                    <div v-for="lib in customLibraries" :key="lib.id" class="mb-6 p-3 bg-pink-50 dark:bg-pink-900/30 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex-1">
                                <input v-if="editingCustomLibrary && editingCustomLibrary.id === lib.id"
                                    v-model="editingCustomLibrary.name"
                                    @keyup.enter="saveCustomLibraryName"
                                    @blur="saveCustomLibraryName"
                                    class="w-full px-2 py-1 bg-white dark:bg-gray-800 rounded border border-pink-500"/>
                                <span v-else class="font-medium">{{ lib.name }}</span>
                            </div>
                            <div class="flex space-x-2">
                                <button @click="toggleCustomLibraryCollapse(lib)" class="text-gray-500 hover:text-gray-900" :title="lib._collapsed ? '展开' : '折叠'">
                                    <i :class="lib._collapsed ? 'fas fa-chevron-down' : 'fas fa-chevron-up'"></i>
                                </button>
                                <button @click="editCustomLibraryName(lib)" class="text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button @click="deleteCustomLibrary(lib)" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button @click.stop="exportCustomLibrary(lib)" class="text-xs text-green-500 hover:text-green-700 mt-1" title="导出为Base64">
                                    <i class="fas fa-file-export"></i>
                                </button>
                            </div>
                        </div>
                        <!-- 词条内容编辑区，折叠控制 -->
                        <div v-show="!lib._collapsed">
                            <div v-for="(word, idx) in lib.words" :key="idx" class="flex items-center gap-2 mb-1">
                                <input v-model="lib.words[idx].word1" placeholder="词1" class="w-1/3 px-2 py-1 rounded border border-pink-300"/>
                                <input v-model="lib.words[idx].word2" placeholder="词2" class="w-1/3 px-2 py-1 rounded border border-pink-300"/>
                                <input v-if="lib.type==='triple'" v-model="lib.words[idx].word3" placeholder="词3" class="w-1/3 px-2 py-1 rounded border border-pink-300"/>
                                <button @click="removeCustomWord(lib, idx)" class="text-red-500 hover:text-red-700"><i class="fas fa-minus-circle"></i></button>
                            </div>
                            <button @click="addCustomWord(lib)" class="mt-2 px-2 py-1 bg-pink-200 dark:bg-pink-700 rounded hover:bg-pink-300 dark:hover:bg-pink-600 text-pink-900 dark:text-pink-100 text-sm">
                                <i class="fas fa-plus mr-1"></i>添加词条
                            </button>
                        </div>
                    </div>
                    <div v-if="customLibraries.length === 0" class="text-center py-8 text-gray-500">
                        <i class="fas fa-inbox text-3xl mb-3"></i>
                        <p>暂无自定义词库</p>
                    </div>
                </div>
                <!-- 导入Base64入口 -->
                <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex flex-col gap-2">
                    <div class="flex gap-2 items-center">
                        <input v-model="importBase64Text" placeholder="粘贴Base64编码词库" class="flex-1 px-2 py-1 rounded border border-pink-300"/>
                        <button @click="importCustomLibraryFromBase64" class="px-3 py-1 bg-green-200 dark:bg-green-700 rounded hover:bg-green-300 dark:hover:bg-green-600 text-green-900 dark:text-green-100 text-sm">
                            <i class="fas fa-file-import mr-1"></i>导入
                        </button>
                    </div>
                    <div class="flex justify-between mt-2">
                        <button @click="addEmptyCustomLibrary" class="px-4 py-2 bg-pink-200 dark:bg-pink-700 rounded-lg hover:bg-pink-300 dark:hover:bg-pink-600 text-pink-900 dark:text-pink-100">
                            <i class="fas fa-plus mr-1"></i>新增空白词库
                        </button>
                        <button @click="showCustomLibraryManager = false" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">
                            关闭
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 底部 -->
        <footer class="p-4 text-center text-sm text-gray-500 bg-white dark:bg-gray-800 mt-auto">
            © 2025 词点 | 你的专属词库练习与管理工具
        </footer>
    </div>

    <script>
        const { createApp } = Vue;
        
        createApp({
            data() {
                return {
                    theme: localStorage.theme || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'),
                    // 标准五十音行数据
                    kanaRows: [
                        { id: 'row-1', name: 'あ行', kana: ['あ','い','う','え','お'], katakana: ['ア','イ','ウ','エ','オ'], romaji: ['a','i','u','e','o'] },
                        { id: 'row-2', name: 'か行', kana: ['か','き','く','け','こ'], katakana: ['カ','キ','ク','ケ','コ'], romaji: ['ka','ki','ku','ke','ko'] },
                        { id: 'row-3', name: 'さ行', kana: ['さ','し','す','せ','そ'], katakana: ['サ','シ','ス','セ','ソ'], romaji: ['sa','shi','su','se','so'] },
                        { id: 'row-4', name: 'た行', kana: ['た','ち','つ','て','と'], katakana: ['タ','チ','ツ','テ','ト'], romaji: ['ta','chi','tsu','te','to'] },
                        { id: 'row-5', name: 'な行', kana: ['な','に','ぬ','ね','の'], katakana: ['ナ','ニ','ヌ','ネ','ノ'], romaji: ['na','ni','nu','ne','no'] },
                        { id: 'row-6', name: 'は行', kana: ['は','ひ','ふ','へ','ほ'], katakana: ['ハ','ヒ','フ','ヘ','ホ'], romaji: ['ha','hi','fu','he','ho'] },
                        { id: 'row-7', name: 'ま行', kana: ['ま','み','む','め','も'], katakana: ['マ','ミ','ム','メ','モ'], romaji: ['ma','mi','mu','me','mo'] },
                        { id: 'row-8', name: 'や行', kana: ['や','ゆ','よ'], katakana: ['ヤ','ユ','ヨ'], romaji: ['ya','yu','yo'] },
                        { id: 'row-9', name: 'ら行', kana: ['ら','り','る','れ','ろ'], katakana: ['ラ','リ','ル','レ','ロ'], romaji: ['ra','ri','ru','re','ro'] },
                        { id: 'row-10', name: 'わ行', kana: ['わ','を'], katakana: ['ワ','ヲ'], romaji: ['wa','wo'] },
                        { id: 'row-11', name: 'が行', kana: ['が','ぎ','ぐ','げ','ご'], katakana: ['ガ','ギ','グ','ゲ','ゴ'], romaji: ['ga','gi','gu','ge','go'] },
                        { id: 'row-12', name: 'ざ行', kana: ['ざ','じ','ず','ぜ','ぞ'], katakana: ['ザ','ジ','ズ','ゼ','ゾ'], romaji: ['za','ji','zu','ze','zo'] },
                        { id: 'row-13', name: 'だ行', kana: ['だ','ぢ','づ','で','ど'], katakana: ['ダ','ヂ','ヅ','デ','ド'], romaji: ['da','ji','zu','de','do'] },
                        { id: 'row-14', name: 'ば行', kana: ['ば','び','ぶ','べ','ぼ'], katakana: ['バ','ビ','ブ','ベ','ボ'], romaji: ['ba','bi','bu','be','bo'] },
                        { id: 'row-15', name: 'ぱ行', kana: ['ぱ','ぴ','ぷ','ぺ','ぽ'], katakana: ['パ','ピ','プ','ペ','ポ'], romaji: ['pa','pi','pu','pe','po'] },
                        { id: 'row-16', name: 'きゃ行', kana: ['きゃ','きゅ','きょ'], katakana: ['キャ','キュ','キョ'], romaji: ['kya','kyu','kyo'] },
                        { id: 'row-17', name: 'しゃ行', kana: ['しゃ','しゅ','しょ'], katakana: ['シャ','シュ','ショ'], romaji: ['sha','shu','sho'] },
                        { id: 'row-18', name: 'ちゃ行', kana: ['ちゃ','ちゅ','ちょ'], katakana: ['チャ','チュ','チョ'], romaji: ['cha','chu','cho'] },
                        { id: 'row-19', name: 'にゃ行', kana: ['にゃ','にゅ','にょ'], katakana: ['ニャ','ニュ','ニョ'], romaji: ['nya','nyu','nyo'] },
                        { id: 'row-20', name: 'ひゃ行', kana: ['ひゃ','ひゅ','ひょ'], katakana: ['ヒャ','ヒュ','ヒョ'], romaji: ['hya','hyu','hyo'] },
                        { id: 'row-21', name: 'みゃ行', kana: ['みゃ','みゅ','みょ'], katakana: ['ミャ','ミュ','ミョ'], romaji: ['mya','myu','myo'] },
                        { id: 'row-22', name: 'りゃ行', kana: ['りゃ','りゅ','りょ'], katakana: ['リャ','リュ','リョ'], romaji: ['rya','ryu','ryo'] },
                        { id: 'row-23', name: 'ぎゃ行', kana: ['ぎゃ','ぎゅ','ぎょ'], katakana: ['ギャ','ギュ','ギョ'], romaji: ['gya','gyu','gyo'] },
                        { id: 'row-24', name: 'じゃ行', kana: ['じゃ','じゅ','じょ'], katakana: ['ジャ','ジュ','ジョ'], romaji: ['ja','ju','jo'] },
                        { id: 'row-25', name: 'びゃ行', kana: ['びゃ','びゅ','びょ'], katakana: ['ビャ','ビュ','ビョ'], romaji: ['bya','byu','byo'] },
                        { id: 'row-26', name: 'ぴゃ行', kana: ['ぴゃ','ぴゅ','ぴょ'], katakana: ['ピャ','ピュ','ピョ'], romaji: ['pya','pyu','pyo'] }
                    ],
                    
                    // 推荐的长数据集
                    recommendedGroups: [
                        { 
                            id: 'group-all-clear', 
                            name: '所有清音', 
                            kana: [
                                'あ','い','う','え','お',
                                'か','き','く','け','こ',
                                'さ','し','す','せ','そ',
                                'た','ち','つ','て','と',
                                'な','に','ぬ','ね','の',
                                'は','ひ','ふ','へ','ほ',
                                'ま','み','む','め','も',
                                'や','ゆ','よ',
                                'ら','り','る','れ','ろ',
                                'わ','を'
                            ],
                            katakana: [
                                'ア','イ','ウ','エ','オ',
                                'カ','キ','ク','ケ','コ',
                                'サ','シ','ス','セ','ソ',
                                'タ','チ','ツ','テ','ト',
                                'ナ','ニ','ヌ','ネ','ノ',
                                'ハ','ヒ','フ','ヘ','ホ',
                                'マ','ミ','ム','メ','モ',
                                'ヤ','ユ','ヨ',
                                'ラ','リ','ル','レ','ロ',
                                'ワ','ヲ'
                            ],
                            romaji: [
                                'a','i','u','e','o',
                                'ka','ki','ku','ke','ko',
                                'sa','shi','su','se','so',
                                'ta','chi','tsu','te','to',
                                'na','ni','nu','ne','no',
                                'ha','hi','fu','he','ho',
                                'ma','mi','mu','me','mo',
                                'ya','yu','yo',
                                'ra','ri','ru','re','ro',
                                'wa','wo'
                            ]
                        },
                        { 
                            id: 'group-all-voiced', 
                            name: '所有浊音', 
                            kana: [
                                'が','ぎ','ぐ','げ','ご',
                                'ざ','じ','ず','ぜ','ぞ',
                                'だ','ぢ','づ','で','ど',
                                'ば','び','ぶ','べ','ぼ',
                                'ぱ','ぴ','ぷ','ぺ','ぽ'
                            ],
                            katakana: [
                                'ガ','ギ','グ','ゲ','ゴ',
                                'ザ','ジ','ズ','ゼ','ゾ',
                                'ダ','ヂ','ヅ','デ','ド',
                                'バ','ビ','ブ','ベ','ボ',
                                'パ','ピ','プ','ペ','ポ'
                            ],
                            romaji: [
                                'ga','gi','gu','ge','go',
                                'za','ji','zu','ze','zo',
                                'da','ji','zu','de','do',
                                'ba','bi','bu','be','bo',
                                'pa','pi','pu','pe','po'
                            ]
                        },
                        { 
                            id: 'group-all-yoon', 
                            name: '所有拗音', 
                            kana: [
                                'きゃ','きゅ','きょ',
                                'しゃ','しゅ','しょ',
                                'ちゃ','ちゅ','ちょ',
                                'にゃ','にゅ','にょ',
                                'ひゃ','ひゅ','ひょ',
                                'みゃ','みゅ','みょ',
                                'りゃ','りゅ','りょ',
                                'ぎゃ','ぎゅ','ぎょ',
                                'じゃ','じゅ','じょ',
                                'びゃ','びゅ','びょ',
                                'ぴゃ','ぴゅ','ぴょ'
                            ],
                            katakana: [
                                'キャ','キュ','キョ',
                                'シャ','シュ','ショ',
                                'チャ','チュ','チョ',
                                'ニャ','ニュ','ニョ',
                                'ヒャ','ヒュ','ヒョ',
                                'ミャ','ミュ','ミョ',
                                'リャ','リュ','リョ',
                                'ギャ','ギュ','ギョ',
                                'ジャ','ジュ','ジョ',
                                'ビャ','ビュ','ビョ',
                                'ピャ','ピュ','ピョ'
                            ],
                            romaji: [
                                'kya','kyu','kyo',
                                'sha','shu','sho',
                                'cha','chu','cho',
                                'nya','nyu','nyo',
                                'hya','hyu','hyo',
                                'mya','myu','myo',
                                'rya','ryu','ryo',
                                'gya','gyu','gyo',
                                'ja','ju','jo',
                                'bya','byu','byo',
                                'pya','pyu','pyo'
                            ]
                        }
                    ],
                    
                    // 导入的词库
                    importedLibraries: [],
                    
                    selectedRow: null,
                    mode: 'kana-romaji',
                    questionType: 'multiple',
                    currentQuestion: null,
                    currentOptions: [],
                    userInput: '',
                    feedback: '',
                    correctAnswer: '',
                    dictionary: [],
                    stats: {
                        total: 0,
                        correct: 0
                    },
                    direction: 'hira-to-kata',
                    
                    // 词库管理相关状态
                    showLibraryManager: false,
                    editingLibrary: null,
                    isCustomMode: false, // 新增：自定义模式状态
                    customLibraries: [], // 自定义词库列表
                    selectedCustomLibrary: null,
                    customQuestionType: 'multiple',
                    currentCustomQuestion: null,
                    currentCustomOptions: [],
                    customUserInput: '',
                    customFeedback: '',
                    customCorrectAnswer: '',
                    customStats: { total: 0, correct: 0 },
                    editingCustomLibrary: null,
                    currentView: 'japanese', // 'japanese' 或 'custom'
                    tripleMode: 'a-b', // 三词词库对照模式

                    // 自定义词库管理模态框状态
                    showCustomLibraryManager: false,
                    importBase64Text: '',
                };
            },
            computed: {
                modeDescription() {
                    const modes = {
                        'kana-romaji': '罗马音',
                        'romaji-kana': '假名',
                        'hiragana-katakana': '片假名'
                    };
                    return modes[this.mode] || '';
                },
                questionPrompt() {
                    if (!this.currentQuestion) return '';
                    
                    if (this.mode === 'kana-romaji') {
                        return this.currentQuestion.kana;
                    }
                    else if (this.mode === 'romaji-kana') {
                        return this.currentQuestion.romaji;
                    }
                    else if (this.mode === 'hiragana-katakana') {
                        return this.direction === 'hira-to-kata'
                            ? this.currentQuestion.kana
                            : this.currentQuestion.katakana;
                    }
                    return '';
                },
                accuracy() {
                    if (this.stats.total === 0) return 0;
                    return Math.round((this.stats.correct / this.stats.total) * 100);
                },
                hasDuplicateOptions() {
                    return this.currentOptions.some(opt => opt.includes('*'));
                },
                customModeDescription() {
                    if (!this.selectedCustomLibrary) return '';
                    if (this.selectedCustomLibrary.type === 'double') return '关联词';
                    if (this.selectedCustomLibrary.type === 'triple') return '三词关联';
                    return '';
                },
                customQuestionPrompt() {
                    if (!this.currentCustomQuestion) return '';
                    if (this.selectedCustomLibrary && this.selectedCustomLibrary.type === 'triple') {
                        if (this.tripleMode === 'a-b') return this.currentCustomQuestion.word1;
                        if (this.tripleMode === 'b-c') return this.currentCustomQuestion.word2;
                        if (this.tripleMode === 'a-c') return this.currentCustomQuestion.word1;
                    }
                    // 双词默认 word1
                    return this.currentCustomQuestion.word1;
                }
            },
            methods: {
                toggleTheme() {
                    this.theme = this.theme === 'dark' ? 'light' : 'dark';
                    localStorage.theme = this.theme;
                    if (this.theme === 'dark') {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                },
                selectRow(row) {
                    this.selectedRow = row;
                    this.nextQuestion();
                },
                // 选择导入的词库
                selectLibrary(lib) {
                    this.selectedRow = {
                        id: lib.id,
                        name: lib.name,
                        kana: lib.words.map(w => w.kana),
                        katakana: lib.words.map(w => w.katakana),
                        romaji: lib.words.map(w => w.romaji)
                    };
                    this.nextQuestion();
                },
                setMode(m) {
                    this.mode = m;
                    this.nextQuestion();
                },
                answer(choice) {
                    this.stats.total++;
                    
                    let correct = '';
                    if (this.mode === 'kana-romaji') {
                        correct = this.currentQuestion.romaji;
                    }
                    else if (this.mode === 'romaji-kana') {
                        correct = this.currentQuestion.kana;
                    }
                    else if (this.mode === 'hiragana-katakana') {
                        correct = this.direction === 'hira-to-kata'
                            ? this.currentQuestion.katakana
                            : this.currentQuestion.kana;
                    }
                    
                    this.correctAnswer = correct;
                    
                    if (choice === correct) {
                        this.feedback = '正确';
                        this.stats.correct++;
                    } else {
                        this.feedback = '错误';
                    }
                },
                submitAnswer() {
                    this.stats.total++;
                    const ans = this.userInput.trim();
                    
                    let correct = '';
                    if (this.mode === 'kana-romaji') {
                        correct = this.currentQuestion.romaji;
                    }
                    else if (this.mode === 'romaji-kana') {
                        correct = this.currentQuestion.kana;
                    }
                    else if (this.mode === 'hiragana-katakana') {
                        correct = this.direction === 'hira-to-kata'
                            ? this.currentQuestion.katakana
                            : this.currentQuestion.kana;
                    }
                    
                    this.correctAnswer = correct;
                    
                    if (ans === correct) {
                        this.feedback = '正确';
                        this.stats.correct++;
                    } else {
                        this.feedback = '错误';
                    }
                    
                    this.userInput = '';
                },
                nextQuestion() {
                    this.feedback = '';
                    this.userInput = '';
                    
                    // 获取当前可用的选项池
                    let pool = this.getAvailablePool();
                    
                    if (pool.length === 0) {
                        this.currentQuestion = null;
                        return;
                    }
                    
                    // 随机选择一个问题
                    const index = Math.floor(Math.random() * pool.length);
                    this.currentQuestion = pool[index];
                    
                    // 对于平假名-片假名模式，随机选择方向
                    if (this.mode === 'hiragana-katakana') {
                        this.direction = Math.random() > 0.5 ? 'hira-to-kata' : 'kata-to-hira';
                    }
                    
                    // 生成选项（仅选择题）
                    if (this.questionType === 'multiple') {
                        this.currentOptions = this.generateOptions(pool);
                    }
                },
                // 生成选项（确保只使用当前行的假名）
                generateOptions(pool) {
                    const options = [];
                    const correctAnswer = this.getCorrectAnswer();
                    options.push(correctAnswer);
                    
                    // 先尝试用当前行其他假名作为干扰项
                    const currentRowItems = pool.filter(item =>
                        this.mode === 'kana-romaji' ? item.romaji !== correctAnswer :
                            this.mode === 'romaji-kana' ? item.kana !== correctAnswer :
                                this.direction === 'hira-to-kata' ? item.katakana !== correctAnswer :
                                    item.kana !== correctAnswer
                    );
                    
                    // 优先添加当前行其他假名
                    let addedFromCurrentRow = 0;
                    const maxFromCurrentRow = Math.min(3, currentRowItems.length); // 最多取3个
                    
                    while (options.length < 4 && addedFromCurrentRow < maxFromCurrentRow) {
                        const randomItem = currentRowItems[Math.floor(Math.random() * currentRowItems.length)];
                        const candidate = this.getCandidateAnswer(randomItem);
                        
                        if (candidate && !options.includes(candidate)) {
                            options.push(candidate);
                            addedFromCurrentRow++;
                        }
                    }
                    
                    // 如果仍然不足，允许有限重复（标记星号）
                    while (options.length < 4) {
                        const randomItem = pool[Math.floor(Math.random() * pool.length)];
                        const candidate = this.getCandidateAnswer(randomItem);
                        options.push(candidate + (options.includes(candidate) ? "*" : ""));
                    }
                    
                    return options.sort(() => Math.random() - 0.5);
                },
                
                // 修改获取选项池逻辑（不再跨行获取）
                getAvailablePool() {
                    let pool = [];
                    
                    if (this.dictionary.length > 0) {
                        pool = this.dictionary;
                    } else if (this.selectedRow) {
                        // 只从当前行获取
                        for (let i = 0; i < this.selectedRow.kana.length; i++) {
                            if (this.selectedRow.kana[i] && this.selectedRow.romaji[i]) {
                                pool.push({
                                    kana: this.selectedRow.kana[i],
                                    katakana: this.selectedRow.katakana[i],
                                    romaji: this.selectedRow.romaji[i]
                                });
                            }
                        }
                    }
                    
                    return pool;
                },
                
                // 获取正确答案
                getCorrectAnswer() {
                    if (this.mode === 'kana-romaji') {
                        return this.currentQuestion.romaji;
                    }
                    else if (this.mode === 'romaji-kana') {
                        return this.currentQuestion.kana;
                    }
                    else if (this.mode === 'hiragana-katakana') {
                        return this.direction === 'hira-to-kata'
                            ? this.currentQuestion.katakana
                            : this.currentQuestion.kana;
                    }
                    return "";
                },
                
                // 获取候选答案
                getCandidateAnswer(item) {
                    if (this.mode === 'kana-romaji') {
                        return item.romaji;
                    }
                    else if (this.mode === 'romaji-kana') {
                        return item.kana;
                    }
                    else if (this.mode === 'hiragana-katakana') {
                        return this.direction === 'hira-to-kata'
                            ? item.katakana
                            : item.kana;
                    }
                    return "";
                },
                
                // 加载JSON词库
                loadJson(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.addEventListener('load', () => {
                        try {
                            const data = JSON.parse(reader.result);
                            
                            // 创建新词库对象
                            const newLibrary = {
                                id: 'lib-' + Date.now(),
                                name: '词库-' + (this.importedLibraries.length + 1),
                                words: []
                            };
                            
                            // 处理导入数据
                            data.forEach(item => {
                                if (item.kana && item.romaji) {
                                    newLibrary.words.push({
                                        kana: item.kana,
                                        katakana: item.katakana || item.kana,
                                        romaji: item.romaji
                                    });
                                }
                            });
                            
                            if (newLibrary.words.length > 0) {
                                this.importedLibraries.push(newLibrary);
                                this.saveLibrariesToStorage();
                                alert('成功导入 ' + newLibrary.words.length + ' 条词汇！');
                                
                                // 自动选择新导入的词库
                                this.selectLibrary(newLibrary);
                            } else {
                                alert('未找到有效词汇数据！');
                            }
                        } catch (e) {
                            console.error(e);
                            alert('JSON 解析失败，请检查文件格式。');
                        }
                    });
                    reader.readAsText(file);
                },
                
                // 下载示例JSON
                downloadSample() {
                    const sampleData = [
                        { kana: "こんにちは", romaji: "konnichiwa" },
                        { kana: "ありがとう", romaji: "arigatou" },
                        { kana: "さようなら", romaji: "sayounara" }
                    ];
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(sampleData, null, 2));
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", "日语词汇示例.json");
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                },
                
                // 编辑词库名称
                editLibraryName(lib) {
                    this.editingLibrary = {...lib};
                },
                
                // 保存词库名称
                saveLibraryName() {
                    if (this.editingLibrary) {
                        const index = this.importedLibraries.findIndex(l => l.id === this.editingLibrary.id);
                        if (index !== -1) {
                            this.importedLibraries[index].name = this.editingLibrary.name;
                            this.saveLibrariesToStorage();
                        }
                        this.editingLibrary = null;
                    }
                },
                
                // 删除词库
                deleteLibrary(lib) {
                    if (confirm(`确定要删除词库 "${lib.name}" 吗？`)) {
                        this.importedLibraries = this.importedLibraries.filter(l => l.id !== lib.id);
                        this.saveLibrariesToStorage();
                        
                        // 如果删除的是当前选中的词库，清空选择
                        if (this.selectedRow && this.selectedRow.id === lib.id) {
                            this.selectedRow = null;
                            this.currentQuestion = null;
                        }
                    }
                },
                
                // 保存词库到本地存储
                saveLibrariesToStorage() {
                    localStorage.setItem('kanaLibraries', JSON.stringify(this.importedLibraries));
                },
                
                // 从本地存储加载词库
                loadLibrariesFromStorage() {
                    const savedLibraries = localStorage.getItem('kanaLibraries');
                    if (savedLibraries) {
                        this.importedLibraries = JSON.parse(savedLibraries);
                    }
                },

                // 进入自定义词库练习模式
                enterCustomMode() {
                    this.isCustomMode = true;
                    this.selectedRow = null; // 清空当前选中的假名组
                    this.mode = 'kana-romaji'; // 默认模式为假名
                    this.questionType = 'multiple'; // 默认题型为选择题
                    this.nextQuestion(); // 加载第一个问题
                },

                // 退出自定义词库练习模式
                exitCustomMode() {
                    this.isCustomMode = false;
                    this.selectedRow = null; // 清空当前选中的假名组
                    this.mode = 'kana-romaji'; // 默认模式为假名
                    this.questionType = 'multiple'; // 默认题型为选择题
                    this.nextQuestion(); // 加载第一个问题
                },

                // 自定义模式相关方法
                loadCustomJson(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.addEventListener('load', () => {
                        try {
                            const data = JSON.parse(reader.result);
                            let type = 'double';
                            if (data.length > 0 && data[0].word3) type = 'triple';
                            const newLibrary = {
                                id: 'custom-' + Date.now(),
                                name: '自定义词库-' + (this.customLibraries.length + 1),
                                type,
                                words: data
                            };
                            if (newLibrary.words.length > 0) {
                                this.customLibraries.push(newLibrary);
                                this.saveCustomLibrariesToStorage();
                                alert('成功导入 ' + newLibrary.words.length + ' 条词汇！');
                                this.selectCustomLibrary(newLibrary);
                            } else {
                                alert('未找到有效词汇数据！');
                            }
                        } catch (e) {
                            alert('JSON 解析失败，请检查文件格式。');
                        }
                    });
                    reader.readAsText(file);
                },
                downloadCustomSample(type) {
                    let sampleData = [];
                    let filename = '';
                    if (type === 'double') {
                        sampleData = [
                            { word1: '中国', word2: '北京' },
                            { word1: '日本', word2: '东京' },
                            { word1: '法国', word2: '巴黎' }
                        ];
                        filename = '双词词库示例.json';
                    } else {
                        sampleData = [
                            { word1: '广东', word2: '广州', word3: '粤' },
                            { word1: '山东', word2: '济南', word3: '鲁' },
                            { word1: '四川', word2: '成都', word3: '川' }
                        ];
                        filename = '三词词库示例.json';
                    }
                    const dataStr = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(sampleData, null, 2));
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute('href', dataStr);
                    downloadAnchorNode.setAttribute('download', filename);
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                },
                selectCustomLibrary(lib) {
                    this.selectedCustomLibrary = lib;
                    this.nextCustomQuestion();
                },
                editCustomLibraryName(lib) {
                    this.editingCustomLibrary = { ...lib };
                },
                saveCustomLibraryName() {
                    if (this.editingCustomLibrary) {
                        const index = this.customLibraries.findIndex(l => l.id === this.editingCustomLibrary.id);
                        if (index !== -1) {
                            this.customLibraries[index].name = this.editingCustomLibrary.name;
                            this.saveCustomLibrariesToStorage();
                        }
                        this.editingCustomLibrary = null;
                    }
                },
                deleteCustomLibrary(lib) {
                    if (confirm(`确定要删除词库 "${lib.name}" 吗？`)) {
                        this.customLibraries = this.customLibraries.filter(l => l.id !== lib.id);
                        this.saveCustomLibrariesToStorage();
                        if (this.selectedCustomLibrary && this.selectedCustomLibrary.id === lib.id) {
                            this.selectedCustomLibrary = null;
                            this.currentCustomQuestion = null;
                        }
                    }
                },
                saveCustomLibrariesToStorage() {
                    localStorage.setItem('customLibraries', JSON.stringify(this.customLibraries));
                },
                loadCustomLibrariesFromStorage() {
                    const saved = localStorage.getItem('customLibraries');
                    if (saved) {
                        this.customLibraries = JSON.parse(saved);
                    }
                },
                // 练习逻辑
                nextCustomQuestion() {
                    this.customFeedback = '';
                    this.customUserInput = '';
                    if (!this.selectedCustomLibrary || this.selectedCustomLibrary.words.length === 0) {
                        this.currentCustomQuestion = null;
                        return;
                    }
                    const pool = this.selectedCustomLibrary.words;
                    const index = Math.floor(Math.random() * pool.length);
                    this.currentCustomQuestion = pool[index];
                    if (this.customQuestionType === 'multiple') {
                        this.currentCustomOptions = this.generateCustomOptions(pool);
                    }
                },
                generateCustomOptions(pool) {
                    const options = [];
                    const correct = this.getCustomCorrectAnswer();
                    options.push(correct);
                    let candidates;
                    if (this.selectedCustomLibrary.type === 'triple') {
                        // 根据 tripleMode 选择干扰项
                        if (this.tripleMode === 'a-b') {
                            candidates = pool.map(item => item.word2);
                        } else if (this.tripleMode === 'b-c') {
                            candidates = pool.map(item => item.word3);
                        } else if (this.tripleMode === 'a-c') {
                            candidates = pool.map(item => item.word3);
                        } else {
                            candidates = [];
                        }
                    } else {
                        candidates = pool.map(item => item.word2);
                    }
                    // 去重并排除正确答案
                    candidates = candidates.filter((item, idx, arr) => arr.indexOf(item) === idx && item !== correct);
                    while (options.length < 4 && candidates.length > 0) {
                        const randomIdx = Math.floor(Math.random() * candidates.length);
                        options.push(candidates.splice(randomIdx, 1)[0]);
                    }
                    while (options.length < 4) {
                        options.push('——');
                    }
                    return options.sort(() => Math.random() - 0.5);
                },
                getCustomCorrectAnswer() {
                    if (!this.currentCustomQuestion) return '';
                    if (this.selectedCustomLibrary.type === 'triple') {
                        if (this.tripleMode === 'a-b') return this.currentCustomQuestion.word2;
                        if (this.tripleMode === 'b-c') return this.currentCustomQuestion.word3;
                        if (this.tripleMode === 'a-c') return this.currentCustomQuestion.word3;
                    }
                    // 双词默认 word1->word2
                    return this.currentCustomQuestion.word2;
                },
                answerCustom(choice) {
                    this.customStats.total++;
                    const correct = this.getCustomCorrectAnswer();
                    this.customCorrectAnswer = correct;
                    if (choice === correct) {
                        this.customFeedback = '正确';
                        this.customStats.correct++;
                    } else {
                        this.customFeedback = '错误';
                    }
                },
                submitCustomAnswer() {
                    this.customStats.total++;
                    const ans = this.customUserInput.trim();
                    const correct = this.getCustomCorrectAnswer();
                    this.customCorrectAnswer = correct;
                    if (ans === correct) {
                        this.customFeedback = '正确';
                        this.customStats.correct++;
                    } else {
                        this.customFeedback = '错误';
                    }
                    this.customUserInput = '';
                },
                switchToCustom() {
                    this.currentView = 'custom';
                },
                switchToJapanese() {
                    this.currentView = 'japanese';
                },
                addEmptyCustomLibrary() {
                    const id = 'custom-' + Date.now();
                    this.customLibraries.push({
                        id,
                        name: '新建词库',
                        type: 'double',
                        words: []
                    });
                    this.saveCustomLibrariesToStorage();
                },
                addCustomWord(lib) {
                    if (lib.type === 'triple') {
                        lib.words.push({ word1: '', word2: '', word3: '' });
                    } else {
                        lib.words.push({ word1: '', word2: '' });
                    }
                    this.saveCustomLibrariesToStorage();
                },
                removeCustomWord(lib, idx) {
                    lib.words.splice(idx, 1);
                    this.saveCustomLibrariesToStorage();
                },
                exportCustomLibrary(lib) {
                    const json = JSON.stringify({
                        name: lib.name,
                        type: lib.type,
                        words: lib.words
                    });
                    const compressed = LZString.compressToBase64(json);
                    // 复制到剪贴板
                    navigator.clipboard.writeText(compressed).then(() => {
                        alert('已复制到剪贴板！');
                    }, () => {
                        prompt('复制以下Base64内容：', compressed);
                    });
                },
                importCustomLibraryFromBase64() {
                    if (!this.importBase64Text.trim()) {
                        alert('请输入Base64编码内容');
                        return;
                    }
                    try {
                        const json = LZString.decompressFromBase64(this.importBase64Text.trim());
                        const data = JSON.parse(json);
                        if (!data || !data.words || !Array.isArray(data.words)) throw new Error('格式错误');
                        const id = 'custom-' + Date.now();
                        this.customLibraries.push({
                            id,
                            name: data.name || '导入词库',
                            type: data.type || 'double',
                            words: data.words
                        });
                        this.saveCustomLibrariesToStorage();
                        this.importBase64Text = '';
                        alert('导入成功！');
                    } catch (e) {
                        alert('导入失败，内容无效或已损坏！');
                    }
                },
                toggleCustomLibraryCollapse(lib) {
                    if (lib._collapsed === undefined) this.$set ? this.$set(lib, '_collapsed', true) : (lib._collapsed = true);
                    lib._collapsed = !lib._collapsed;
                }
            },
            created() {
                // 主题初始化，兼容 tailwindcss dark 方案
                if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    this.theme = 'dark';
                    document.documentElement.classList.add('dark');
                } else {
                    this.theme = 'light';
                    document.documentElement.classList.remove('dark');
                }
                // 从本地存储加载词库
                this.loadLibrariesFromStorage();
                this.loadCustomLibrariesFromStorage(); // 加载自定义词库
                // 初始化时默认折叠所有自定义词库内容
                this.customLibraries.forEach(lib => { lib._collapsed = true; });
                // 移除自动添加的内置自定义词库（不做任何内置库初始化）
            }
        }).mount('#app');
    </script>
</body>

</html>